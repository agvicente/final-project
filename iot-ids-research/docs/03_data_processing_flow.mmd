%% ========================================
%% Diagrama 3: Fluxo de Processamento de Dados
%% Formato: Mermaid (Detailed Flow)
%% Mostra como os dados fluem desde raw atÃ© resultados
%% Com foco na prevenÃ§Ã£o de data leakage
%% ========================================

graph LR
    subgraph "Raw Data Ingestion"
        RAW["ğŸ“¦ CICIoT2023<br/>Raw CSV Files<br/>~46M records<br/>Multiple attack types"]
        QUALITY["ğŸ” Quality Check<br/>âœ“ Missing values<br/>âœ“ Duplicates<br/>âœ“ Data types<br/>âœ“ Label distribution"]
        
        RAW --> QUALITY
    end
    
    subgraph "Sampling & Balancing"
        SAMPLE["ğŸ“Š Stratified Sampling<br/>âœ“ Maintain class proportions<br/>âœ“ Random state = 42<br/>âœ“ Configurable size"]
        BALANCED["âš–ï¸ Sampled Dataset<br/>sampled.csv<br/>Balanced classes<br/>Representative sample"]
        
        QUALITY --> SAMPLE
        SAMPLE --> BALANCED
    end
    
    subgraph "Exploratory Data Analysis"
        EDA_DIST["ğŸ“ˆ Distribution Analysis<br/>- Feature distributions<br/>- Correlation matrix<br/>- Class balance"]
        EDA_STATS["ğŸ“Š Statistical Analysis<br/>- Descriptive stats<br/>- ANOVA tests<br/>- Skewness & CV"]
        EDA_VIZ["ğŸ¨ Visualizations<br/>- Plots<br/>- Tables<br/>- Reports"]
        
        BALANCED --> EDA_DIST
        EDA_DIST --> EDA_STATS
        EDA_STATS --> EDA_VIZ
    end
    
    subgraph "Critical: Prevent Data Leakage"
        direction TB
        SPLIT["âœ‚ï¸ SPLIT FIRST<br/><b>train_test_split</b><br/>80% train / 20% test<br/>stratified by label<br/>random_state = 42"]
        
        subgraph "Train Set Processing"
            TRAIN_RAW["ğŸ“‹ X_train (raw)<br/>y_train"]
            SCALER_FIT["ğŸ”§ StandardScaler<br/><b>fit_transform</b><br/>Learn Î¼, Ïƒ from TRAIN only"]
            TRAIN_NORM["âœ¨ X_train_normalized<br/>Î¼ â‰ˆ 0, Ïƒ â‰ˆ 1"]
            
            TRAIN_RAW --> SCALER_FIT
            SCALER_FIT --> TRAIN_NORM
        end
        
        subgraph "Test Set Processing"
            TEST_RAW["ğŸ“‹ X_test (raw)<br/>y_test"]
            SCALER_TRANSFORM["ğŸ”§ StandardScaler<br/><b>transform</b><br/>Apply Î¼, Ïƒ from TRAIN"]
            TEST_NORM["âœ¨ X_test_normalized<br/>Î¼ â‰ˆ 0.02, Ïƒ â‰ˆ 0.98<br/>(slight deviation OK)"]
            
            TEST_RAW --> SCALER_TRANSFORM
            SCALER_TRANSFORM --> TEST_NORM
        end
        
        SPLIT --> TRAIN_RAW
        SPLIT --> TEST_RAW
        SCALER_FIT -.->|"Scaler params"| SCALER_TRANSFORM
        
        EDA_VIZ --> SPLIT
    end
    
    subgraph "Data Persistence"
        direction TB
        
        CSV["ğŸ’¾ CSV Files<br/>train_normalized.csv<br/>test_normalized.csv<br/>(Human readable)"]
        
        NPY["âš¡ NumPy Arrays<br/>X_train.npy, y_train.npy<br/>X_test.npy, y_test.npy<br/>(ML optimized)"]
        
        SCALER_PKL["ğŸ”§ Scaler Object<br/>scaler.pkl<br/>(Production use)"]
        
        META["ğŸ“‹ Metadata<br/>preprocessing_metadata.json<br/>- Feature names<br/>- Config used<br/>- Statistics"]
        
        TRAIN_NORM --> CSV
        TEST_NORM --> CSV
        TRAIN_NORM --> NPY
        TEST_NORM --> NPY
        SCALER_FIT --> SCALER_PKL
        SPLIT --> META
    end
    
    subgraph "Binary Classification Variant"
        BINARY["ğŸ”€ Binary Transform<br/>Attack vs Normal<br/>Separate pipeline<br/>binary/ folder"]
        
        CSV -.-> BINARY
        NPY -.-> BINARY
    end
    
    subgraph "ML Training Ready"
        READY["âœ… Ready for ML<br/>- No data leakage<br/>- Reproducible<br/>- Normalized<br/>- Balanced<br/>- Multiple formats"]
        
        NPY --> READY
        BINARY --> READY
    end
    
    style SPLIT fill:#ffcdd2,stroke:#d32f2f,stroke-width:3px
    style SCALER_FIT fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style SCALER_TRANSFORM fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px
    style READY fill:#c8e6c9,stroke:#388e3c,stroke-width:3px
    style QUALITY fill:#e3f2fd
    style SAMPLE fill:#e3f2fd

