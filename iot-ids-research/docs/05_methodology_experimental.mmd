%% ========================================
%% Diagrama 5: Metodologia Experimental
%% Formato: Mermaid (Sequencial detalhado)
%% Documenta a metodologia científica completa do experimento
%% ========================================

flowchart TD
    subgraph "Phase 1: Dataset Preparation"
        direction TB
        P1_1["📦 Dataset Selection<br/><b>CICIoT2023</b><br/>- Real-world IoT traffic<br/>- 33 attack types<br/>- ~46M samples"]
        
        P1_2["🔍 Quality Assessment<br/>- Check missing values<br/>- Identify duplicates<br/>- Validate labels<br/>- Distribution analysis"]
        
        P1_3["📊 Stratified Sampling<br/>- Maintain class proportions<br/>- Random seed = 42<br/>- Configurable sample size<br/>- Reproducible selection"]
        
        P1_4["✅ Dataset Validation<br/>- Verify balance<br/>- Statistical tests<br/>- Document metadata"]
        
        P1_1 --> P1_2
        P1_2 --> P1_3
        P1_3 --> P1_4
    end
    
    subgraph "Phase 2: Feature Engineering"
        direction TB
        P2_1["📈 Exploratory Analysis<br/>- Feature distributions<br/>- Correlation analysis<br/>- Outlier detection<br/>- Class separability"]
        
        P2_2["✂️ Train-Test Split<br/><b>CRITICAL: Before normalization</b><br/>- 80% / 20% split<br/>- Stratified by label<br/>- Random state = 42"]
        
        P2_3["🔧 Feature Normalization<br/><b>StandardScaler</b><br/>- Fit on TRAIN only<br/>- Transform both sets<br/>- Prevent data leakage"]
        
        P2_4["💾 Data Persistence<br/>- Save normalized data<br/>- Export scaler object<br/>- Store metadata<br/>- Multiple formats"]
        
        P2_1 --> P2_2
        P2_2 --> P2_3
        P2_3 --> P2_4
    end
    
    subgraph "Phase 3: Algorithm Configuration"
        direction TB
        P3_1["📋 Hyperparameter Design<br/>- Grid of configurations<br/>- Complexity levels<br/>- Resource constraints<br/>- Domain knowledge"]
        
        P3_2["🎯 Adaptive Strategy<br/>- Fast algorithms: more params<br/>- Slow algorithms: fewer params<br/>- TEST_MODE support<br/>- Time budget per algorithm"]
        
        P3_3["🔄 Execution Planning<br/>- Order by complexity<br/>- N_RUNS per config<br/>- Resource monitoring<br/>- Failure handling"]
        
        P3_1 --> P3_2
        P3_2 --> P3_3
    end
    
    subgraph "Phase 4: Experimentation"
        direction TB
        P4_1["🏋️ Model Training<br/>- Fit on training set<br/>- Monitor training time<br/>- Track memory usage<br/>- CPU profiling"]
        
        P4_2["🔮 Model Evaluation<br/>- Predict on test set<br/>- Measure latency<br/>- Calculate throughput<br/>- Resource snapshots"]
        
        P4_3["📏 Metrics Collection<br/><b>Performance:</b><br/>- Accuracy, Precision, Recall<br/>- F1, Balanced Accuracy<br/>- ROC-AUC, Confusion Matrix<br/><b>Resources:</b><br/>- Training/Prediction time<br/>- Memory (peak & avg)<br/>- CPU utilization"]
        
        P4_4["🗂️ MLflow Tracking<br/>- Log parameters<br/>- Log metrics<br/>- Store artifacts<br/>- Version models"]
        
        P4_1 --> P4_2
        P4_2 --> P4_3
        P4_3 --> P4_4
    end
    
    subgraph "Phase 5: Statistical Analysis"
        direction TB
        P5_1["📊 Individual Analysis<br/>- Aggregate by param_id<br/>- Calculate mean & std<br/>- Confidence intervals<br/>- Parameter sensitivity"]
        
        P5_2["🔗 Cross-Algorithm Comparison<br/>- Performance rankings<br/>- Resource efficiency<br/>- Trade-off analysis<br/>- Statistical tests"]
        
        P5_3["📈 Advanced Analytics<br/>- Pareto frontier<br/>- Scalability analysis<br/>- Boxplots & distributions<br/>- Correlation studies"]
        
        P5_1 --> P5_2
        P5_2 --> P5_3
    end
    
    subgraph "Phase 6: Reporting & Visualization"
        direction TB
        P6_1["📑 Report Generation<br/>- Summary statistics<br/>- Best configurations<br/>- Comparison tables<br/>- JSON exports"]
        
        P6_2["🎨 Visualization Suite<br/>- Performance charts<br/>- Resource plots<br/>- Radar charts<br/>- Heatmaps"]
        
        P6_3["📝 Publication Ready<br/>- High-res figures<br/>- LaTeX tables<br/>- Supplementary data<br/>- Reproducibility info"]
        
        P6_1 --> P6_2
        P6_2 --> P6_3
    end
    
    %% Connections between phases
    P1_4 --> P2_1
    P2_4 --> P3_1
    P3_3 --> P4_1
    P4_4 --> P5_1
    P5_3 --> P6_1
    
    %% Reproducibility
    REPRO["🔄 Reproducibility<br/>- DVC pipeline<br/>- Fixed random seeds<br/>- Version control<br/>- Docker support"]
    
    P1_1 -.->|Tracked by| REPRO
    P2_2 -.->|Tracked by| REPRO
    P3_1 -.->|Tracked by| REPRO
    P4_1 -.->|Tracked by| REPRO
    
    %% Styling
    style P1_1 fill:#e3f2fd
    style P2_2 fill:#ffcdd2,stroke:#d32f2f,stroke-width:2px
    style P2_3 fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style P4_3 fill:#c8e6c9
    style P6_3 fill:#c8e6c9
    style REPRO fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px

